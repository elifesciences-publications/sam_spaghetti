.. toctree::
   :maxdepth: 2

.. _script-architecture:

################################################################################
File architecture requirements for executing the scripts
################################################################################

The execution of the quantification scripts requires a number of directories to be passed as arguments, and will rely on several files that should be found in these directories to work properly.

The general idea is that the set of microscope image files (.czi, .lsm and .tif formats are supported) corresponding to one experiment are placed in a given folder, with no naming constraints. However, all the files generated by the pipeline follow a very strict nomenclature that requires some manual configuration by the user, through the definition of configuration `.csv` files.


Script directory arguments
--------------------------

All scripts operating on microscope image files allow the user to fill in three directory path, using the following syntax:

.. code-block:: bash

    -dir PATH, --data-directory PATH

    -Mdir PATH, --microscopy-directory PATH

    -o PATH, --output-directory PATH


- :code:`data_directory` corresponds to the root directory containing the user's data. For the execution of the scripts, it is necessary that this directory contains the following configuration files, for which the specifications are given in the next section :
    - :code:`experiment_info.csv`
    - :code:`nomenclature.csv`
    - :code:`nuclei_image_sam_orientation.csv` (only if performing sequence alignment)
    - :code:`signal_ranges.csv` (OPTIONAL, used to customize visualizations)

- :code:`microscopy_directory` corresponds to the root directory containing the user's microscope image file directories. Each experiment is expected to correspond to one directory in the :code:`microscopy_directory`. The default setting for its path is : :code:`data_directory/microscopy/`.

- :code:`output_directory` corresponds to the root directory that will contain all the files produced by the script. In this directory, each individual image sequence (identified by its nomenclature name) will have its own directory, which will contain one directory per time frame. The default setting for its path is : :code:`data_directory/nuclei_images/`

Configuration `.csv` files
--------------------------------

Examples for all `.csv` files are provided in the :code:`share/data` folder of the :mod:`sam_spaghetti` repository.

- :code:`experiment_info.csv` contains the necessary information to describe one experiment. An experiment is assumed to consist of a collection of time-lapse acquisitions of shoot apical meristems imaged with identical settings (and notably identical image channels). The `.csv` file should contain the following columns:

    :experiment: Unique textual (spaceless) identifier for the experiment.
    :experiment_name: Textual (spaceless) identifier that will be used to build nomenclature names.
    :microscopy_directory: The name of the subdirectory of :code:`microscopy_directory` that corresponds to the experiment.
    :channel_names: A list of names for the channels of the microscopy image. Some channel names are required for the scripts to work.
    :reference_name: The name of the channel to use as a reference for detection in the script.

.. csv-table:: Example file for :code:`experiment_info.csv`
   :file: ../../share/data/experiment_info.csv
   :delim: ;
   :header-rows: 1

- :code:`nomenclature.csv` is the file that allows to make the link between individual image files with their own naming, and the strict nomenclature used by the scripts. It associates each image file to an experiment and assigns it a numerical SAM identifier and a temporal position (in hours). The `.csv` file should contain the following columns:

    :filename: The exact name of the image file (with its extension) as it is in its experiment microscopy directory.
    :experiment: The textual identifier of the experiment to which the file is associated.
    :sam_id: The numerical identifier (between 0 and 99) assigned to the SAM in the experiment, used to identify its time-lapse sequence.
    :hour_time: The time in hours (between 0 and 99) since the first acquisition of the SAM time-lapse sequence.

.. csv-table:: Example file for :code:`nomenclature.csv`
   :file: ../../share/data/nomenclature.csv
   :delim: ;
   :header-rows: 1

- :code:`nuclei_image_sam_orientation.csv` assigns to each individual sequence the orientation (counter-clockwise or clockwise, respectively 1 and -1) of the phyllotactic spiral of the SAM. The `.csv` file should contain the following columns:

    :experiment: The textual identifier of the experiment to which the SAM is associated.
    :sam_id: The numerical identifier of the SAM time-lapse sequence.
    :orientation: The value of the phyllotactic orientation of the SAM (-1 or 1).

.. csv-table:: Example file for :code:`nuclei_image_sam_orientation.csv`
   :file: ../../share/data/nuclei_image_sam_orientation.csv
   :delim: ;
   :header-rows: 1

- :code:`signal_ranges.csv` is used to define custom colormaps and intensity ranges for image, nuclei and map visualization of the signals quantified from the images. The `.csv` file should contain the following columns:

    :signal_name: The name of the signal (corresponding to one of the image channels, or the result of the script computatton such as `Auxin` or `mean_curvature`)
    :colormap: The name of the colormap associated with the signal (chosen among the `Matplotlib named colormaps<https://matplotlib.org/3.1.0/tutorials/colors/colormaps.html>`_)
    :signal_range: The range of values on which the colormap will be stretched for the display of max intensity  image projections.
    :channel_range: The range of values on which the colormap will be stretched for the display of L1 slice image projections.
    :color_range: The range of values on which the colormap will be stretched for the display of nuclei signals and signal maps.

.. csv-table:: Example file for :code:`signal_ranges.csv`
   :file: ../../share/data/signal_ranges.csv
   :delim: ;
   :header-rows: 1
